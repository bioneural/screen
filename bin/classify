#!/usr/bin/env ruby
# bin/classify — classify input against a condition via LLM
# MIT License — Copyright (c) 2026 Kerry Ivan Kurian
#
# Reads JSON from stdin:
#   { "condition": "...", "model": "gemma3:1b",
#     "file_path": "...", "command": "...", "prompt": "...", "content": "..." }
#
# Prints "yes" or "no" to stdout. Exits 0 on success, 1 on failure.
#
# Dependencies: ruby stdlib, ollama

require_relative '../lib/classifier'
require 'json'
require 'open3'

SPILL_HOME = ENV['SPILL_HOME'] || File.expand_path('../../spill', __dir__)
if File.directory?(SPILL_HOME)
  require File.join(SPILL_HOME, 'lib', 'spill')
  Spill.configure(tool: 'classify')
end

input = JSON.parse($stdin.read)
condition = input.delete('condition')
model = input.delete('model') || CLASSIFIER_MODEL

fields = build_classifier_input(input)
if fields.empty?
  defined?(Spill) ? Spill.error("no input fields provided") : $stderr.puts("classify: no input fields provided")
  exit 1
end

prompt = CLASSIFIER_TEMPLATE % { condition: condition, fields: fields }
stdout, status = Open3.capture2('ollama', 'run', model, stdin_data: prompt, err: File::NULL)

unless status.success?
  defined?(Spill) ? Spill.error("ollama exited with #{status.exitstatus}") : $stderr.puts("classify: ollama exited with #{status.exitstatus}")
  exit 1
end

puts stdout.strip.downcase.start_with?('yes') ? 'yes' : 'no'
