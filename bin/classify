#!/usr/bin/env ruby
# bin/classify â€” classify input against a condition via LLM
#
# Reads JSON from stdin:
#   { "condition": "...", "model": "gemma3:1b",
#     "file_path": "...", "command": "...", "prompt": "...", "content": "..." }
#
# Prints "yes" or "no" to stdout. Exits 0 on success, 1 on failure.
#
# Dependencies: ruby stdlib, ollama

require_relative '../lib/classifier'
require 'json'
require 'open3'

input = JSON.parse($stdin.read)
condition = input.delete('condition')
model = input.delete('model') || CLASSIFIER_MODEL

fields = build_classifier_input(input)
if fields.empty?
  $stderr.puts "classify: no input fields provided"
  exit 1
end

prompt = CLASSIFIER_TEMPLATE % { condition: condition, fields: fields }
stdout, status = Open3.capture2('ollama', 'run', model, stdin_data: prompt)

unless status.success?
  $stderr.puts "classify: ollama exited with #{status.exitstatus}"
  exit 1
end

puts stdout.strip.downcase.start_with?('yes') ? 'yes' : 'no'
